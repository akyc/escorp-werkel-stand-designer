<!-- <link rel="stylesheet" href="https://eurosvet.ru/css/figma-plugin-ds/figma-plugin-ds.css"> -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/css/bootstrap.min.css">

<style>
  .hidden {
    display: none;
    opacity: 0;
    visibility: hidden;
  }

  .wrapper {
    padding: 10px 20px;
  }

  .section {
    margin-bottom: 30px;
  }

  #loader {
    text-align: center;
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, .4);
    backdrop-filter: blur(2px);
    color: #fff;
    display: flex;
    flex-direction: column;
    justify-content: center;
  }
</style>
<div id="loader">
  <span class="loader-inner type--medium type--inverse"> Загрузка... </span>
</div>
<div class="wrapper">
  <div class="alert alert-warning alert-dismissible fade show" role="alert">
    <small>Добавить механизмы и рамки на страницу, выделить для просчета и&nbsp;нажать кнопку «Расчет»</small>
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
  </div>

  <div class="btn-group btn-group-sm section" role="group" aria-label="Basic example">
    <button id="calc-products" type="button" class="btn btn-outline-dark">Расчет</button>
    <button id="draw-schema" type="button" class="btn btn-outline-dark">Нарисовать схему</button>
    <button id="export-schema" type="button" class="btn btn-outline-dark" disabled>Экспорт схемы</button>
    <button id="delete-schema" type="button" class="btn btn-outline-danger hidden">Удалить схему</button>
  </div>

  <div class="section type--small">
    <table id="result" class="table"></table>
  </div>

  <div class="section products">
    <ul class="nav" id="products_tabs" role="tablist">
      <li class="nav-item" role="presentation">
        <a class="nav-link active" id="mech-tab" data-bs-toggle="tab" data-bs-target="#mech-tab-pane" role="tab"
          aria-controls="mech-tab-pane" aria-selected="true"><small>Механизмы</small></a>
      </li>
      <li class="nav-item" role="presentation">
        <a class="nav-link" id="frame-tab" data-bs-toggle="tab" data-bs-target="#frame-tab-pane" role="tab"
          aria-controls="frame-tab-pane" aria-selected="false"><small>Рамки</small></a>
      </li>
      <li class="nav-item" role="presentation" disabled>
        <a class="nav-link" id="search-tab" data-bs-toggle="tab" data-bs-target="#search-tab-pane" role="tab"
          aria-controls="search-tab-pane" aria-selected="false" disabled><small>Поиск</small></a>
      </li>
    </ul>
    <div class="tab-content pt-3" id="products_tabs-сontent">
      <div class="tab-pane fade show active" id="mech-tab-pane" role="tabpanel" aria-labelledby="mech-tab" tabindex="0">
        <div class="row">
          <div class="col-6">
            <a class="add text-decoration-none text-dark" href="#" data-code="a050756">
              <div class="d-flex align-items-center">
                <div class="flex-shrink-0">
                  <img src="https://eurosvet.info/catalog/images/products/preview/1a050756_0001.jpg" width="100"
                    alt="...">
                </div>
                <div class="flex-grow-1 ms-3">
                  <b>a050756</b>
                  <small>Выключатель двухклавишный графит рифленый</small>
                </div>
              </div>
            </a>
          </div>
        </div>
      </div>
      <div class="tab-pane fade" id="frame-tab-pane" role="tabpanel" aria-labelledby="frame-tab" tabindex="0">
        <div class="row">
          <div class="col-6">
            <a class="add text-decoration-none text-dark" href="#" data-code="a037687">
              <div class="d-flex align-items-center">
                <div class="flex-shrink-0">
                  <img src="https://eurosvet.info/catalog/images/products/preview/1a037687_0001.jpg" width="100"
                    alt="...">
                </div>
                <div class="flex-grow-1 ms-3">
                  <b>a037687</b>
                  <small>Рамка из металла на 1 пост Palacio бронза/черный</small>
                </div>
              </div>
            </a>
          </div>
          <div class="col-6">
            <a class="add text-decoration-none text-dark" href="#" data-code="a037682">
              <div class="d-flex align-items-center">
                <div class="flex-shrink-0">
                  <img src="https://eurosvet.info/catalog/images/products/preview/1a037682_0001.jpg" width="100"
                    alt="...">
                </div>
                <div class="flex-grow-1 ms-3">
                  <b>a037682</b>
                  <small>Рамка из металла на 1 пост Palacio бронза/белый</small>
                </div>
              </div>
            </a>
          </div>
          <div class="col-6">
            <a class="add text-decoration-none text-dark" href="#" data-code="a051271">
              <div class="d-flex align-items-center">
                <div class="flex-shrink-0">
                  <img src="https://eurosvet.info/catalog/images/products/preview/1a051271_0001.jpg" width="100"
                    alt="...">
                </div>
                <div class="flex-grow-1 ms-3">
                  <b>a051271</b>
                  <small>Рамка из пластика на 5 постов Stream графит</small>
                </div>
              </div>
            </a>
          </div>
        </div>
      </div>
      <div class="tab-pane fade" id="search-tab-pane" role="tabpanel" aria-labelledby="search-tab" tabindex="0">
        <div class="row">
          <div class="col-12">
            <input class="form-control form-control-lg" type="text" placeholder="Поиск..."
              aria-label=".form-control-lg">
          </div>
        </div>
      </div>
    </div>
  </div>

</div>

<!-- <script src="https://eurosvet.ru/css/figma-plugin-ds/iife/figma-plugin-ds.js"></script> -->
<script src="	https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
  console.clear()
  let shemaGroupId = null;
  document.addEventListener("DOMContentLoaded", function () {
    loadDb('https://eurosvet.info/app/js/db.js').then(
      resolve => { document.querySelector('#loader').classList.add('hidden') },
      error => { console.error('Load db.js failed. ', error) }
    )
  })

  document.getElementById('calc-products').onclick = () => {
    parent.postMessage({ pluginMessage: { type: 'calc-products' } }, '*')
  }

  document.getElementById('draw-schema').onclick = () => {
    parent.postMessage({ pluginMessage: { type: 'draw-schema' } }, '*')
  }

  document.getElementById('export-schema').onclick = () => {
    parent.postMessage({ pluginMessage: { type: 'export-schema', 'shemaGroupId': shemaGroupId } }, '*')
  }

  document.getElementById('delete-schema').onclick = () => {
    parent.postMessage({ pluginMessage: { type: 'delete-schema', 'shemaGroupId': shemaGroupId } }, '*')
  }

  document.querySelectorAll('.add').forEach(el => el.addEventListener('click', function (e) { addProduct(this.dataset.code) }))

  function addProduct(code) {
    const link = 'https://minimir.ru/image/get?url=' + encodeURIComponent(`https://minimir.ru/images/stand-designer/${code}.png`);
    Promise.all([getImage(link), getMeta(link)].map(p => p.catch(x => console.error(x)))).then(
      r => {
        let [image, size] = r;
        parent.postMessage({ pluginMessage: { type: 'createImage', 'image': image, 'code': code, 'size': size } }, '*')
      }
    );
  }
  function renderFrames() {
    //db['categories']['3324']
  }

  function loadDb(url) {
    return new Promise((resolve, reject) => {
      const script = document.createElement('script');
      script.onload = resolve;
      script.onerror = reject;
      script.src = url;
      script.charset = 'utf-8'
      document.body.appendChild(script)
    })
  }

  function showResult(result) {
    let tpl = '',
      header = '<thead><tr><th scope="col">№</th><th scope="col">Наименование</th><th scope="col">Код</th><th scope="col">Кол-во</th><th scope="col">Цена</th></tr></thead>'
    Object.keys(result).forEach((code, i) => {
      if (code in db['products']) {
        let [name, price] = [db['products'][code]['n'], db['products'][code]['p']['49']]
        tpl += `<tr><th scope="row">${i + 1}</th><td>${name}</td><td>${code}</td><td nowrap>${result[code]}</td><td nowrap>${price}&nbsp;₽/шт.</td></tr>`
      }
    })
    document.querySelector('#result').innerHTML = "";
    document.querySelector('#result').innerHTML = header + tpl;
  }


  window.onmessage = event => {
    const message = event.data.pluginMessage;
    if (message.type === 'calc-result') {
      if (message.value) {
        showResult(message.value)
      } else {
        document.querySelector('#result').innerHTML = "Нет элементов для расчета";
      }
    }
    if (message.type === 'nodes-to-del') {
      shemaGroupId = message.shemaGroupId
      document.querySelector('#delete-schema').classList.remove('hidden')
    }
  };

  function getMeta(url) {
    const img = new Image()
    img.src = url
    return new Promise((resolve, reject) => {
      img.onload = () => resolve([img.width, img.height])
    })
  }

  async function getImage(imageURI) {
    const resp = await fetch(imageURI);
    const blob = await resp.blob();
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => resolve(new Uint8Array(reader.result));
      reader.onerror = () => reject(new Error('Could not read from blob'));
      reader.readAsArrayBuffer(blob);
    });
  }
</script>