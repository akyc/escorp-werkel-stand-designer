<link rel="stylesheet" href="https://eurosvet.ru/css/figma-plugin-ds/figma-plugin-ds.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/css/bootstrap.min.css">

<style>
  .hidden {
    display: none;
    opacity: 0;
    visibility: hidden;
  }

  .wrapper {
    padding: 10px 20px;
  }

  .section {
    margin-bottom: 30px;
  }

  .controls {
    display: flex;
    flex-direction: row;

  }

  .controls .button {
    margin-right: 5px;

  }

  #loader {
    text-align: center;
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, .4);
    backdrop-filter: blur(2px);
    color: #fff;
    display: flex;
    flex-direction: column;
    justify-content: center;
  }
</style>
<div id="loader">
  <span class="loader-inner type--medium type--inverse"> Загрузка... </span>
</div>
<div class="wrapper">
  <div class="section info">
    <p class="type--small">Выделите необходимые механизмы и рамки для просчета и&nbsp;нажмите кнопку «Посчетать»</p>
  </div>
  <div class="section controls">
    <button id="copy" class="button button--primary">Посчетать</button>
    <button id="draw-schema" class="button button--secondary">Нарисовать схему</button>
    <button id="delete-schema" class="button button--secondary-destructive hidden">Удалить схему</button>
  </div>
  <div class="section products">

    <a class="add" href="#" data-code="a051271">
      <img src="https://eurosvet.info/catalog/images/products/preview/1a051271_0001.jpg" alt="" width="60">
      <!-- a051271 -->
    </a>
    <a class="add" href="#" data-code="a050756">
      <img src="https://eurosvet.info/catalog/images/products/preview/1a050756_0001.jpg" alt="" width="60">
      <!-- a050756 -->
    </a>
  </div>
  <div class="section type--small">
    <table id="result" class="table"></table>
  </div>
</div>

<script src="https://eurosvet.ru/css/figma-plugin-ds/iife/figma-plugin-ds.js"></script>
<script>
  let deleteNodeList = [];
  document.addEventListener("DOMContentLoaded", function () {
    loadDb()
  })

  document.getElementById('copy').onclick = () => {
    parent.postMessage({ pluginMessage: { type: 'copy' } }, '*')
  }

  document.getElementById('draw-schema').onclick = () => {
    parent.postMessage({ pluginMessage: { type: 'draw-schema' } }, '*')
  }

  document.getElementById('delete-schema').onclick = () => {
    console.log(deleteNodeList)
    parent.postMessage({ pluginMessage: { type: 'delete-schema', 'list': deleteNodeList } }, '*')
  }

  document.querySelectorAll('.add').forEach(el => el.addEventListener('click', function (e) { addProduct(this.dataset.code) }))

  function addProduct(code) {
    const link = 'https://minimir.ru/image/get?url=' + encodeURIComponent(`https://minimir.ru/images/stand-designer/${code}.png`);
    Promise.all([getImage(link), getMeta(link)].map(p => p.catch(x => console.error(x)))).then(
      r => {
        let [image, size] = r;
        parent.postMessage({ pluginMessage: { type: 'createImage', 'image': image, 'code': code, 'size': size } }, '*')
      }
    );
  }

  function loadDb() {
    const dbFile = document.createElement('script');
    dbFile.src = 'https://eurosvet.info/app/js/db.js';
    dbFile.charset = 'utf-8'
    document.body.appendChild(dbFile)
    dbFile.onload = () => document.querySelector('#loader').classList.add('hidden')
  }

  function showResult(result) {
    let tpl = '',
      header = '<thead><tr><th scope="col">№</th><th scope="col">Наименование</th><th scope="col">Код</th><th scope="col">Кол-во</th><th scope="col">Цена</th></tr></thead>'
    Object.keys(result).forEach((code, i) => {
      if (code in db['products']) {
        let [name, price] = [db['products'][code]['n'], db['products'][code]['p']['49']]
        tpl += `<tr><th scope="row">${i + 1}</th><td>${name}</td><td>${code}</td><td nowrap>${result[code]}</td><td nowrap>${price}&nbsp;₽/шт.</td></tr>`
      }
    })
    document.querySelector('#result').innerHTML = "";
    document.querySelector('#result').innerHTML = header + tpl;
  }


  window.onmessage = event => {
    const message = event.data.pluginMessage;
    if (message.type === 'ok') {
      if (message.value) {
        showResult(message.value)
      } else {
        document.querySelector('#result').innerHTML = "Нет выделенных элементов";
      }
    }
    if (message.type === 'nodes-to-del') {
      deleteNodeList = message.list
      document.querySelector('#delete-schema').classList.remove('hidden')
    }
  };

  function getMeta(url) {
    const img = new Image()
    img.src = url
    return new Promise((resolve, reject) => {
      img.onload = () => resolve([img.width, img.height])
    })
  }

  async function getImage(imageURI) {
    const resp = await fetch(imageURI);
    const blob = await resp.blob();
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => resolve(new Uint8Array(reader.result));
      reader.onerror = () => reject(new Error('Could not read from blob'));
      reader.readAsArrayBuffer(blob);
    });
  }
</script>