<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/css/bootstrap.min.css">

<style>
  .hidden {
    display: none;
    opacity: 0;
    visibility: hidden;
  }

  #products_tabs {
    border-top: 1.1px solid rgb(230, 230, 230);
    border-bottom: 1.1px solid rgb(230, 230, 230);
  }

  #products_tabs .nav-link {
    color: rgba(0, 0, 0, .7);
    transition: color .5s ease;
  }

  #products_tabs .nav-link.active {
    color: rgba(0, 0, 0, 1);
    font-weight: 600;
    padding: 8px 14px;
  }

  #loader {
    text-align: center;
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, .4);
    backdrop-filter: blur(2px);
    color: #fff;
    display: flex;
    flex-direction: column;
    justify-content: center;
  }

  a.disabled {
    opacity: .2;
  }
</style>
<div id="loader">
  <span class="loader-inner type--medium type--inverse"> Загрузка... </span>
</div>
<div class="container-fluid">
  <div class="wrapper">

    <div class="btn-group btn-group-sm section py-1" role="group" aria-label="Basic example">
      <button id="calc-products" type="button" class="btn btn-outline-dark hidden">Расчет</button>
      <button id="draw-schema" type="button" class="btn btn-outline-dark hidden">Нарисовать схему</button>
      <!-- <button id="export-schema" type="button" class="btn btn-outline-dark hidden">Экспорт схемы</button> -->
      <button id="delete-schema" type="button" class="btn btn-outline-danger hidden">Удалить схему</button>
    </div>

    <div class="section type--small">
      <table id="result" class="table"></table>
    </div>

    <div class="section products">
      <ul class="nav" id="products_tabs" role="tablist">
        <!-- <li class="nav-item" role="presentation">
          <a href="#" class="nav-link" id="stand-tab" data-bs-toggle="tab" data-bs-target="#stand-tab-pane" role="tab"
            aria-controls="stand-tab-pane" aria-selected="false">Стенды</a>
        </li> -->
        <li class="nav-item" role="presentation">
          <a href="#" class="nav-link active" id="mech-tab" data-bs-toggle="tab" data-bs-target="#mech-tab-pane"
            role="tab" aria-controls="mech-tab-pane" aria-selected="true">Механизмы</a>
        </li>
        <li class="nav-item" role="presentation">
          <a href="#" class="nav-link" id="frame-tab" data-bs-toggle="tab" data-bs-target="#frame-tab-pane" role="tab"
            aria-controls="frame-tab-pane" aria-selected="false">Рамки</a>
        </li>
        <li class="nav-item" role="presentation">
          <a href="#" class="nav-link" id="search-tab" data-bs-toggle="tab" data-bs-target="#search-tab-pane" role="tab"
            aria-controls="search-tab-pane" aria-selected="false">Поиск</a>
        </li>
      </ul>
      <div class="tab-content pt-3" id="products_tabs-сontent">
        <div class="tab-pane fade show active" id="mech-tab-pane" role="tabpanel" aria-labelledby="mech-tab"
          tabindex="0">
          <div class="row mechs-list"> </div>
        </div>
        <div class="tab-pane fade" id="frame-tab-pane" role="tabpanel" aria-labelledby="frame-tab" tabindex="0">
          <div class="row frames-list"></div>
        </div>
        <div class="tab-pane fade" id="search-tab-pane" role="tabpanel" aria-labelledby="search-tab" tabindex="0">
          <div class="row">
            <div class="col-12">
              <div class="input-group mb-3">
                <input type="text" class="form-control" placeholder="" aria-label="" aria-describedby="button-addon2">
                <button class="btn btn-outline-secondary" type="button" id="button-addon2">Поиск</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>
<script src="	https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
  console.clear()
  let shemaGroupId = null;
  document.addEventListener("DOMContentLoaded", function () {
    loadDb('https://eurosvet.info/app/js/db.js').then(
      resolve => {
        document.querySelector('#loader').classList.add('hidden')
        renderMechanisms()
        renderFrames()
      },
      error => { console.error('Load db.js failed. ', error) }
    )

    parent.postMessage({ pluginMessage: { type: 'seek' } }, '*')
  })

  document.getElementById('calc-products').onclick = () => {
    parent.postMessage({ pluginMessage: { type: 'calc-products' } }, '*')
  }

  document.getElementById('draw-schema').onclick = () => {
    parent.postMessage({ pluginMessage: { type: 'draw-schema' } }, '*')
  }

  document.getElementById('export-schema').onclick = () => {
    parent.postMessage({ pluginMessage: { type: 'export-schema', 'shemaGroupId': shemaGroupId } }, '*')
  }

  document.getElementById('delete-schema').onclick = () => {
    parent.postMessage({ pluginMessage: { type: 'delete-schema', 'shemaGroupId': shemaGroupId } }, '*')
    parent.postMessage({ pluginMessage: { type: 'seek' } }, '*')
  }

  document.querySelectorAll('.add').forEach(el => el.addEventListener('click', function (e) { addProduct(this.dataset.code) }))

  function addProduct(code) {
    const link = 'https://minimir.ru/image/get?url=' + encodeURIComponent(`https://minimir.ru/images/stand-designer/${code}.png`);
    Promise.all([getImage(link), getMeta(link)].map(p => p.catch(x => console.error(x)))).then(
      r => {
        let [image, size] = r;
        parent.postMessage({ pluginMessage: { type: 'createImage', 'image': image, 'code': code, 'size': size } }, '*')
        parent.postMessage({ pluginMessage: { type: 'seek' } }, '*')
      }
    );
  }
  function createMenu(id, parent) {
    let subCategories = Object.keys(db['categories']).filter(category => +db['categories'][category]['pid'] === +id).sort((a, b) => db['categories'][a]['o'] - db['categories'][b]['o'])
    subCategories.forEach(id => {
      let { n } = db['categories'][id]
      let products = db['product_to_categories_relations'][id].sort((a, b) => db['products'][a]['o'] - db['products'][b]['o'])
      let tpl = `
        <div class="col-12">
          <a class="btn" data-bs-toggle="collapse" href="#collapse${id}" role="button" aria-expanded="false" aria-controls="collapse${id}">
            ${n} 
          </a>
        </div>
        <div class="collapse col-12 mb-2" id="collapse${id}">
          <div class="row"></div>
        </div>
      `
      parent.insertAdjacentHTML("beforeend", tpl)
      products.forEach(product => {
        hasReadyImage(product)
        let div = document.createElement('div'),
          a = document.createElement('a');
        div.classList.add('col-6', 'mb-2')
        a.classList.add('add', 'text-decoration-none', 'text-dark')
        a.dataset.code = product
        a.href = '#'
        a.insertAdjacentHTML("beforeend", `
        <div class="d-flex align-items-center">
          <div class="flex-shrink-0">
            <img src="https://eurosvet.info/catalog/images/products/preview/1${product}_0001.jpg" width="70"
              alt="">
          </div>
          <div class="flex-grow-1 ms-3">
            <b>${product}</b>
            <small>${db['products'][product]['n']}</small>
          </div>
        </div>`)
        a.addEventListener('click', function () {
          addProduct(product)
        })
        div.appendChild(a)
        parent.querySelector(`#collapse${id} .row`).appendChild(div)
      })
    })
  }

  function renderFrames() {
    const parent = document.querySelector('.frames-list'),
      framesCategoryId = '3324';
    createMenu(framesCategoryId, parent)
  }

  function renderMechanisms() {
    const parent = document.querySelector('.mechs-list'),
      mechsCategoryId = '3325';
    createMenu(mechsCategoryId, parent)
  }

  function loadDb(url) {
    return new Promise((resolve, reject) => {
      const script = document.createElement('script');
      script.onload = resolve;
      script.onerror = reject;
      script.src = url;
      script.charset = 'utf-8'
      document.body.appendChild(script)
    })
  }

  function showResult(result) {
    let tpl = '',
      header = '<thead><tr><th scope="col">№</th><th scope="col">Наименование</th><th scope="col">Код</th><th scope="col">Кол-во</th><th scope="col">Цена</th></tr></thead>'
    Object.keys(result).forEach((code, i) => {
      if (code in db['products']) {
        let [name, price] = [db['products'][code]['n'], db['products'][code]['p']['49']]
        tpl += `<tr><th scope="row">${i + 1}</th><td>${name}</td><td>${code}</td><td nowrap>${result[code]}</td><td nowrap>${price}&nbsp;₽/шт.</td></tr>`
      }
    })
    document.querySelector('#result').innerHTML = "";
    document.querySelector('#result').innerHTML = header + tpl;
  }


  window.onmessage = event => {
    const msg = event.data.pluginMessage;
    if (msg.type === 'seek-result') {
      const calcButtons = [document.querySelector('#calc-products'), document.querySelector('#draw-schema')],
        schemaButtons = [document.querySelector('#export-schema'), document.querySelector('#delete-schema')];
      if (msg.calc) {
        calcButtons.forEach(btn => btn.classList.remove('hidden'))
      } else {
        calcButtons.forEach(btn => btn.classList.add('hidden'))
      }
      if (msg.schema) {
        shemaGroupId = msg.schema
        schemaButtons.forEach(btn => btn.classList.remove('hidden'))
      } else {
        schemaButtons.forEach(btn => btn.classList.add('hidden'))
      }
    }
    if (msg.type === 'calc-result') {
      if (msg.value) {
        showResult(msg.value)
      } else {
        document.querySelector('#result').innerHTML = "Нет элементов для расчета";
      }
    }
    if (msg.type === 'nodes-to-del') {
      shemaGroupId = msg.shemaGroupId
      document.querySelector('#delete-schema').classList.remove('hidden')
    }
  };

  function getMeta(url) {
    const img = new Image()
    img.src = url
    return new Promise((resolve, reject) => {
      img.onload = () => resolve([img.width, img.height])
      img.onerror = () => reject('false')
    })
  }
  function hasReadyImage(product) {
    const img = new Image();
    img.src = 'https://minimir.ru/image/get?url=' + encodeURIComponent(`https://minimir.ru/images/stand-designer/${product}.png`)
    img.onerror = function () {
      document.querySelector(`[data-code=${product}]`).classList.add('disabled')
    };
  }
  async function getImage(imageURI) {
    const resp = await fetch(imageURI);
    const blob = await resp.blob();
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => resolve(new Uint8Array(reader.result));
      reader.onerror = () => reject(new Error('Could not read from blob'));
      reader.readAsArrayBuffer(blob);
    });
  }
</script>